## LLM Bridge 拡張機能 テストケース

**目的**: LLM Copilot Bridge拡張機能の主要な機能が正しく動作することを確認する。

**前提**:
*   VS Codeが開かれており、この拡張機能がインストールされ、デバッグモードで実行されていること。
*   `LLM Bridge Log` Output ChannelとDeveloper ToolsのConsoleが開かれていること。
*   LLMが`PLAN_PROMPT.md`で定義された形式に従って応答すること。

---

### テストケース 1: プロンプト生成 (`llmBridge.generatePrompt`)

1.  **シナリオ**: コンテキストにファイルがない状態でプロンプトを生成する。
    *   **手順**:
        1.  VS Codeコマンドパレット (`Ctrl+Shift+P` または `Cmd+Shift+P`) を開き、「LLM Bridge: プロンプトを生成」を実行。
    *   **期待される結果**:
        *   「プロンプトをクリップボードにコピーしました (XXX文字)」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] プロンプト生成`と始まるログが表示される。
        *   クリップボードに、`SYSTEM_PROMPT`、現在のモード（閲覧モード）、ディレクトリ構造などが含まれるプロンプトがコピーされている。
        *   `## 提供ファイル`セクションがない、または空である。
2.  **シナリオ**: コンテキストにファイルがある状態でプロンプトを生成する。
    *   **手順**:
        1.  ワークスペース内の適当なファイル（例: `src/extension.ts`）を開く。
        2.  VS Codeコマンドパレットから「LLM Bridge: アクティブファイルをコンテキストに追加」を実行。
        3.  再度VS Codeコマンドパレットから「LLM Bridge: プロンプトを生成」を実行。
    *   **期待される結果**:
        *   「プロンプトをクリップボードにコピーしました (XXX文字)」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] プロンプト生成`と始まるログが表示される。
        *   クリップボードにコピーされたプロンプトに、`## 提供ファイル`セクションがあり、追加したファイルの要約（閲覧モードの場合）が含まれている。

---

### テストケース 2: LLM応答の適用 (`llmBridge.applyResponse`) - ファイルリクエスト

1.  **シナリオ**: LLMが閲覧モードでファイルをリクエストし、拡張機能がそれに応答する。
    *   **前提**: 現在のモードが**閲覧モード**であること。
    *   **手順**:
        1.  （必要であれば）`contextManager.clear()`コマンドやサイドバーのクリア機能でコンテキストをクリアする。
        2.  クリップボードに以下の内容をコピーする。
            ```
            <<<REQUEST_FILE: memo.txt>>>
            <<<END>>>
            ```
        3.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「LLMが1個のファイルをリクエストしました。コンテキストに追加し、新しいプロンプトをクリップボードにコピーしました。LLMにペーストしてください。」というVS Code通知が表示される。
        *   「現在のモードは閲覧モードです。ファイル全文が必要な場合は、LLMの応答に <<<SWITCH_MODE: edit>>> も含めてリクエストしてください。」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] 処理分岐: ファイルリクエストを検出。`と始まるログが表示され、`memo.txt`がコンテキストに追加された旨のログも表示される。
        *   クリップボードにコピーされたプロンプトに、`## 提供ファイル`セクションがあり、`memo.txt`の要約が含まれている。

---

### テストケース 3: LLM応答の適用 (`llmBridge.applyResponse`) - モード切り替え + ファイルリクエスト

1.  **シナリオ**: LLMがモード切り替え（閲覧→編集）とファイルリクエストを同時に行う。
    *   **前提**: 現在のモードが**閲覧モード**であること。
    *   **手順**:
        1.  （必要であれば）`contextManager.clear()`コマンドやサイドバーのクリア機能でコンテキストをクリアする。
        2.  クリップボードに以下の内容をコピーする。
            ```
            <<<SWITCH_MODE: edit>>>
            対象ファイル:
            - memo.txt
            理由: ファイルを編集するため
            <<<END>>>
            ```
        3.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「LLMがモードを「編集」に切り替えることを要求しました。理由: ファイルを編集するため新しいプロンプトをクリップボードにコピーしました。LLMにペーストしてください。」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] 処理分岐: モード切り替えリクエストを検出。`と始まるログが表示され、モードが`edit`に設定された旨、`memo.txt`がコンテキストに追加された旨のログも表示される。
        *   クリップボードにコピーされたプロンプトに、`# ✏️ 現在のモード: 編集モード`と表示され、`## 提供ファイル`セクションに`memo.txt`の**全文**が含まれている。

---

### テストケース 4: LLM応答の適用 (`llmBridge.applyResponse`) - ファイル全体の置換 (`<<<FILE: ...>>>`)

1.  **シナリオ**: LLMが既存ファイルの全体を新しい内容で置換する。
    *   **前提**: ワークスペースに`test_file.txt`が存在し、モードが**編集モード**であること。
    *   **手順**:
        1.  `test_file.txt`というファイルを作成し、以下の内容を記述する。
            ```
            Hello World!
            This is an old line.
            ```
        2.  （必要であれば）モードを編集モードに設定する。
        3.  クリップボードに以下の内容をコピーする。
            ```
<<<FILE: test_file.txt>>>
Hello GPT!
This is a new line.
Another new line.
<<<END>>>
            ```
        4.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「1個のファイルを更新しました」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] 処理分岐: ファイル変更を適用。`と始まるログが表示される。
        *   `test_file.txt`の内容が、クリップボードの内容に完全に置き換わっている。

---

### テストケース 5: LLM応答の適用 (`llmBridge.applyResponse`) - 新規ファイル作成 (`<<<FILE: [NEW] ...>>>`)

1.  **シナリオ**: LLMが新しいファイルを生成する。
    *   **前提**: ワークスペースに`new_file.txt`が存在しないこと。モードが**編集モード**であること。
    *   **手順**:
        1.  （必要であれば）モードを編集モードに設定する。
        2.  クリップボードに以下の内容をコピーする。
            ```
<<<FILE: [NEW] new_file.txt>>>
This is a brand new file.
Generated by LLM Bridge.
<<<END>>>
            ```
        3.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「1個のファイルを更新しました」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] 処理分岐: ファイル変更を適用。`と始まるログが表示される。
        *   ワークスペースのルートに`new_file.txt`が作成され、クリップボードの内容が記述されている。

---

### テストケース 6: LLM応答の適用 (`llmBridge.applyResponse`) - ファイル削除 (`<<<DELETE: ...>>>`)

1.  **シナリオ**: LLMがファイルを削除する。
    *   **前提**: ワークスペースに`delete_me.txt`が存在すること。モードが**編集モード**であること。
    *   **手順**:
        1.  `delete_me.txt`というファイルを作成し、内容を記述する。
        2.  （必要であれば）モードを編集モードに設定する。
        3.  クリップボードに以下の内容をコピーする。
            ```
            <<<DELETE: delete_me.txt>>>
            ```
        4.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「1個のファイルを更新しました」というVS Code通知が表示される。
        *   「削除: delete_me.txt」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] 処理分岐: ファイル変更を適用。`と始まるログが表示される。
        *   `delete_me.txt`がワークスペースから削除されている。

---

### テストケース 7: LLM応答の適用 (`llmBridge.applyResponse`) - 部分置換 (`<<<REPLACE_SECTION: ...>>>`)

1.  **シナリオ**: LLMがファイルの一部を置換する。
    *   **前提**: ワークスペースに`partial_edit.js`が存在し、モードが**編集モード**であること。
    *   **手順**:
        1.  `partial_edit.js`というファイルを作成し、以下の内容を記述する。
            ```javascript
function greet(name) {
    console.log('Hello, ' + name + '!');
    // Some old logic here
}

// Another function
function calculate(a, b) {
    return a + b;
}
            ```
        2.  （必要であれば）モードを編集モードに設定する。
        3.  クリップボードに以下の内容をコピーする。
            ```
<<<REPLACE_SECTION: partial_edit.js>>>
<<<<<<< SEARCH
    console.log('Hello, ' + name + '!');
    // Some old logic here
=======
    console.log(`Hi, ${name}!`);
    // Updated logic here
    // New line added
>>>>>>> REPLACE
<<<END>>>
            ```
        4.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「1個のファイルを更新しました」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] 処理分岐: ファイル変更を適用。`と始まるログが表示される。
        *   `partial_edit.js`内の`SEARCH`部分が`REPLACE`部分に置き換わっている。

---

### テストケース 8: LLM応答の適用 (`llmBridge.applyResponse`) - 複数部分置換 (`<<<REPLACE_SECTION: ...>>>`の複数ブロック)

1.  **シナリオ**: LLMがファイル内の複数の部分を置換する。
    *   **前提**: ワークスペースに`multi_replace.js`が存在し、モードが**編集モード**であること。
    *   **手順**:
        1.  `multi_replace.js`というファイルを作成し、以下の内容を記述する。
            ```javascript
let counter = 0;

function increment() {
    counter++;
    console.log('Counter is ' + counter);
}

function decrement() {
    counter--;
    console.log('Counter is ' + counter);
}
            ```
        2.  （必要であれば）モードを編集モードに設定する。
        3.  クリップボードに以下の内容をコピーする。
            ```
    <<<REPLACE_SECTION: multi_replace.js>>>
    <<<<<<< SEARCH
    console.log('Counter is ' + counter);
    =======
    console.log(`Current counter: ${counter}`);
    >>>>>>> REPLACE
    <<<<<<< SEARCH
    counter--;
    console.log('Counter is ' + counter);
    =======
    counter -= 2; // Decrement by 2
    console.log(`Decrement by 2: ${counter}`);
    >>>>>>> REPLACE
    <<<END>>>
            ```
        4.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「1個のファイルを更新しました」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] 処理分岐: ファイル変更を適用。`と始まるログが表示される。
        *   `multi_replace.js`内の2つの`SEARCH`部分がそれぞれの`REPLACE`部分に置き換わっている。

---

### テストケース 9: LLM応答の適用 (`llmBridge.applyResponse`) - 続きの要求 (`<<<CONTINUE>>>`)

1.  **シナリオ**: LLMが応答の続きを要求する。
    *   **手順**:
        1.  クリップボードに以下の内容をコピーする。
            ```
<<<CONTINUE>>>
残り: 1個のファイル変更があります
- path/to/file1.ts
<<<END>>>
            ```
        2.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「LLMが応答の続きを要求しています。LLMに「続けて」と入力するか、再度プロンプトを生成してペーストしてください。」というVS Code通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] 処理分岐: 続きを要求。`と始まるログが表示される。
        *   ファイルは更新されない。

---

### テストケース 10: LLM応答の適用 (`llmBridge.applyResponse`) - エラーハンドリング (ファイルが見つからない場合)

1.  **シナリオ**: LLMがコンテキストに追加できない存在しないファイルをリクエストする。
    *   **手順**:
        1.  クリップボードに以下の内容をコピーする。
            ```
            <<<REQUEST_FILE: non_existent_file.txt>>>
            <<<END>>>
            ```
        2.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「ファイルの追加に失敗: non_existent_file.txt. エラー: ENOENT: no such file or directory, stat '.../non_existent_file.txt'」のようなVS Codeエラー通知が表示される。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge] エラー:`と始まるログが表示される。

---

### テストケース 11: LLM応答の適用 (`llmBridge.applyResponse`) - エラーハンドリング (REPLACE_SECTIONのSEARCHが見つからない場合)

1.  **シナリオ**: `<<<REPLACE_SECTION: ...>>>`で指定された`SEARCH`内容がファイル内で見つからない場合。
    *   **前提**: ワークスペースに`error_test.js`が存在し、モードが**編集モード**であること。
    *   **手順**:
        1.  `error_test.js`というファイルを作成し、以下の内容を記述する。
            ```javascript
            // This is a test file.
            ```
        2.  （必要であれば）モードを編集モードに設定する。
        3.  クリップボードに以下の内容をコピーする。
            ```
            <<<REPLACE_SECTION: error_test.js>>>
            <<<<<<< SEARCH
            This line does not exist.
            =======
            This is the new content.
            >>>>>>> REPLACE
            <<<END>>>
            ```
        4.  VS Codeコマンドパレットから「LLM Bridge: 回答を適用」を実行。
    *   **期待される結果**:
        *   「1個のファイルを更新しました」というVS Code通知が表示される（`REPLACE_SECTION`は置換がなくても成功とみなされるため）。
        *   Output ChannelとDeveloper Consoleに`[LLM Bridge - Parser] REPLACE_SECTION: Search content not found for file error_test.js ...`のような`warn`ログが表示される。
        *   `error_test.js`の内容は変更されない。

---