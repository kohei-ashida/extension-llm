# LLM Copilot Bridge - プロンプト設計書

このドキュメントは拡張機能が生成するシステムプロンプトの設計を記録しています。
LLMとの対話形式、出力フォーマット、モード切替の仕様を定義します。

---

## 目次
1. [システムプロンプト概要](#システムプロンプト概要)
2. [動作モード](#動作モード)
3. [LLMからの出力形式](#llmからの出力形式)
4. [ファイルリクエスト形式](#ファイルリクエスト形式)
5. [分割送信の対応](#分割送信の対応)

---

## システムプロンプト概要

```
# あなたはコーディングアシスタントです

あなたは優秀なソフトウェアエンジニアとして、ユーザーのコーディングタスクを支援します。
以下のルールに従って回答してください。
```

---

## 動作モード

### 📖 閲覧モード (Browse Mode)
- ファイルの**要約**（シグネチャ、構造）のみが提供される
- **目的**: プロジェクトの概要把握、関連ファイルの特定
- コード変更は行わない
- 詳細を見たいファイルがあれば、後述の「ファイルリクエスト形式」で要求する

### ✏️ 編集モード (Edit Mode)
- ファイルの**完全な内容**が提供される
- **目的**: 実際のコード変更、バグ修正、機能追加
- 後述の「出力形式」でコード変更を出力する

---

## LLMからの出力形式

### コード変更フォーマット

#### 全体置換 (ファイル全体を書き換える場合)
```
<<<FILE: path/to/file.ts>>>
// ファイルの完全な内容をここに記述
// すべての行を含めてください
<<<END>>>
```

#### 新規ファイル作成
```
<<<FILE: [NEW] path/to/newfile.ts>>>
// 新しいファイルの内容
<<<END>>>
```

#### 差分更新 (一部のみ変更する場合)
```
<<<DIFF: path/to/file.ts>>>
@@ -10,5 +10,7 @@
 // 変更前の行 (コンテキスト)
-削除される行
+追加される行
 // 変更後の行 (コンテキスト)
<<<END>>>
```

#### ファイル削除
```
<<<DELETE: path/to/oldfile.ts>>>
```

#### 複数ファイルの変更
```
<<<FILE: src/utils.ts>>>
...コード...
<<<END>>>

<<<FILE: src/index.ts>>>
...コード...
<<<END>>>
```

---

## ファイルリクエスト形式

閲覧モードでファイルの詳細を確認したい場合、LLMは以下の形式で要求します。

### 単一ファイルのリクエスト
```
<<<REQUEST_FILE: path/to/file.ts>>>
```

### 複数ファイルのリクエスト
```
<<<REQUEST_FILES>>>
- path/to/file1.ts
- path/to/file2.ts
- src/utils/helper.ts
<<<END>>>
```

### 編集モードへの切替をリクエスト
```
<<<SWITCH_MODE: edit>>>
対象ファイル:
- path/to/file.ts
理由: バグ修正のために完全なコードが必要です
<<<END>>>
```

### 拡張機能側の対応
上記の形式で出力された場合、拡張機能は:
1. 指定されたファイルをコンテキストに追加
2. モードを切り替え（必要に応じて）
3. 新しいプロンプトを生成してクリップボードにコピー
4. ユーザーに「ファイルが追加されました。プロンプトをLLMにペーストしてください」と通知

---

## 分割送信の対応

### 入力が長い場合（ユーザー→LLM）
プロンプトが文字数制限を超える場合、拡張機能が自動的に分割します。

**パートヘッダー形式:**
```
---
**📦 分割送信: パート N/M**
（続きがあります。すべて受け取ってから処理してください）
---
```

**最終パートのヘッダー:**
```
---
**📦 分割送信: パート M/M**
（これで最後です。処理を開始してください）
---
```

### 出力が長い場合（LLM→ユーザー）
回答が長くなる場合:
```
<<<CONTINUE>>>
残り: N個のファイル変更があります
- path/to/file1.ts
- path/to/file2.ts
<<<END>>>
```

ユーザーが「続けて」と言ったら、残りを出力します。

---

## 使用例

### 例1: 閲覧モードでファイル詳細をリクエスト

**ユーザー入力:**
```
📖 現在のモード: 閲覧モード
## ファイル構造
src/
  utils.ts (exports: formatDate, parseJSON, ...)
  index.ts (main entry, imports: utils)
```

**LLM出力:**
```
バグ修正のために詳細を確認したいです。

<<<REQUEST_FILES>>>
- src/utils.ts
- src/index.ts
<<<END>>>
```

### 例2: 編集モードでコード変更

**ユーザー入力:**
```
✏️ 現在のモード: 編集モード
## src/utils.ts
[完全なコード内容]
```

**LLM出力:**
```
バグを修正しました。parseJSON関数のエラーハンドリングを追加しました。

<<<FILE: src/utils.ts>>>
// 修正済みの完全なコード
export function parseJSON(str: string) {
  try {
    return JSON.parse(str);
  } catch (e) {
    console.error('JSON parse error:', e);
    return null;
  }
}
<<<END>>>
```

---

## 更新履歴
- 2026-02-09: 初版作成、ファイルリクエスト形式を追加
